# Mag 现货提示系统 - 更新日志

## v2.4.0 (2026-01-12)

### 新增功能 ✨

#### 国内A股支持
新增对国内A股资产的完整支持，实现独立的对标和修正逻辑。

**功能说明:**
- 自动识别以"国内"开头的标的（如：国内人工智能、国内机器人）
- 国内A股与美股、BTC平级，不参与对标链验证
- 国内A股不应用美股/BTC/龙头币修正
- 国内A股只应用基础修正：相变修正、爆破指数修正、逼近修正
- 排序展示：国内A股区排在最后，内部按场外指数降序

**数据库变更:**
- coin_daily_data 表新增 `is_cn_stock` 字段（INTEGER, 0/1）
- 新增迁移脚本：`migrations/add_cn_stock_field.py`

**实现细节:**
- **notion_scraper.py**:
  - 自动识别"国内"开头的币种
  - 保留中文全称，不转为大写
  - 优先判断国内A股，避免被误标记为美股

- **database.py**:
  - INSERT语句增加 `is_cn_stock` 字段

- **analyzer.py**:
  - `check_benchmark_chain_pass()`: 国内A股直接返回True
  - `_check_benchmark_chain()`: 国内A股不检查对标链
  - `_calculate_benchmark_divergence_correction()`: 国内A股返回0修正

- **mag_reanalyze.py**:
  - `_get_coin_sort_key()`: 新增分类5（国内A股区）
  - `_build_coin_classification_map()`: 增加 is_cn_stock 字段

**使用示例:**
```python
# Notion数据格式
国内人工智能 场外指数2224 爆破310
场外进场第21天

# 自动识别为国内A股
# is_cn_stock = 1
# 不应用美股/BTC/龙头币修正
# 排序时排在国内A股区
```

**排序规则:**
```
1. 美股区（按场外指数降序）
2. BTC（对标基准）
3. 龙头币（按场外指数降序）
4. 山寨币（按场外指数降序）
5. 国内A股区（按场外指数降序）← 新增
```

**测试验证:**
- 验证国内A股自动识别
- 验证对标链不检查国内A股
- 验证修正系统不应用对标链修正
- 验证排序正确显示在最后

**数据库迁移:**
```bash
# 运行迁移脚本
python3 migrations/add_cn_stock_field.py

# 验证迁移成功
sqlite3 mag_data.db "PRAGMA table_info(coin_daily_data);" | grep is_cn_stock
```

**设计理念:**
国内A股市场具有独立性，不应该被美国市场和加密货币市场的对标链逻辑约束。因此设计为独立体系，与美股、BTC平级，只应用基础的市场规律修正。

### 改进更新 🔧

#### 国内A股识别规则扩展 (2026-01-14)
扩展国内A股识别逻辑，支持更多命名模式。

**变更内容:**
- 从单一前缀匹配("国内")扩展为关键词列表匹配
- 新增支持的关键词：
  - `国内` - 国内人工智能etf、国内机器人etf等
  - `A股指数` - A股指数
  - `A股ETF` - 可能的未来命名
  - `沪深` - 沪深300等
  - `上证` - 上证指数
  - `深证` - 深证指数
  - `创业板` - 创业板指数

**实现方式:**
```python
# 旧版本：只匹配"国内"前缀
if original_coin_name.startswith('国内'):
    is_cn_stock = 1

# 新版本：关键词列表匹配
cn_stock_keywords = ['国内', 'A股指数', 'A股ETF', '沪深', '上证', '深证', '创业板']
if any(keyword in original_coin_name for keyword in cn_stock_keywords):
    is_cn_stock = 1
```

**识别示例:**
- `国内人工智能etf` ✅ 匹配（关键词：国内）
- `国内机器人etf` ✅ 匹配（关键词：国内）
- `A股指数` ✅ 匹配（关键词：A股指数）
- `沪深300指数` ✅ 匹配（关键词：沪深）
- `上证50` ✅ 匹配（关键词：上证）

**向后兼容:**
完全向后兼容，已有的"国内"前缀标的继续正常识别。

---

## v2.3.0 (2025-10-16)

### 重大修复 🐛

#### 修复退场期涨幅计算逻辑错误
修正了基础涨幅和相变修正在进退场期的计算逻辑，之前的实现只适用于进场期。

**问题描述:**
旧版本的计算逻辑：
```python
base_change = ((current_index - ref_index) / ref_index) * 100
phase_correction = 5 if current_index > ref_index else -5
```
这个逻辑只对进场期正确，对退场期完全错误。

**正确规则:**

1. **基础涨幅:**
   - 进场期：场外指数变高→涨幅为正，场外指数变低→涨幅为负
   - 退场期：场外指数变高→涨幅为负，场外指数变低→涨幅为正（完全相反）

2. **相变修正:**
   - 进场期：从<1000→>=1000 +5%，从>=1000→<1000 -5%
   - 退场期：从<1000→>=1000 -5%，从>=1000→<1000 +5%（完全相反）

**实现细节:**
- analyzer.py: 重构 `_calculate_change_percentage()` 方法
- 新增 `phase_type` 参数，根据进退场期调整计算逻辑
- 退场期的基础涨幅和相变修正都反向

**测试验证:**
- test_phase_logic.py: 完整的单元测试
- 验证进场期基础涨幅计算
- 验证退场期基础涨幅计算（反向）
- 验证进场期相变修正
- 验证退场期相变修正（反向）

**影响范围:**
此bug影响所有退场期的分析结果，修复后需要重新分析历史退场期数据。

---

## v2.2.0 (2025-10-16)

### 新增功能 ✨

#### 逼近修正 (Approaching Correction)
新增对"逼近"状态的自动检测和修正规则：

**功能说明:**
- 数据文本中出现"逼近"关键字时自动标记
- 当该日期恰好是关键节点时，应用 -5% 修正
- 后续对比该节点时忽略逼近修正（仅对当日有效）

**修正规则:**
- 当前节点有"逼近"标记 且 是关键节点: -5% 修正

**实现细节:**
- notion_scraper.py: 新增 `_find_approaching()` 方法，自动检测"逼近"关键字
- database.py:
  - coin_daily_data 表新增 `is_approaching` 字段
  - analysis_results 表新增 `approaching_correction` 字段
- analyzer.py: 新增逼近修正计算逻辑
- advisor.py: 在场外指数变化计算中显示逼近修正

**质量判定公式更新:**
```
最终百分比 = 基础涨幅 + 相变修正 + 美股修正 + 爆破指数修正 + 逼近修正
```

**设计理念:**
"逼近"代表场外主力有进场转退场或退场转进场的意愿，属于弱信号。
当这个弱信号出现在关键节点时，给予 -5% 修正以降低质量评级，提醒投资者谨慎。

**测试验证:**
- test_approaching_correction.py: 完整的单元测试
- 支持格式1和格式3的逼近关键字检测
- 验证逼近修正正确应用到分析结果

---

## v2.1.0 (2025-10-16)

### 新增功能 ✨

#### 爆破指数修正
新增针对极端爆破指数的修正规则：

**修正规则:**
- 进场期第一天 且 爆破指数>200: -2.5% 修正
- 退场期第一天 且 爆破指数<0: -2.5% 修正

**实现细节:**
- analyzer.py: 新增 `_calculate_break_index_correction()` 方法
- database.py: 数据库表新增 `break_index_correction` 字段
- 质量判定公式更新: `最终百分比 = 基础涨幅 + 相变修正 + 美股修正 + 爆破指数修正`

**设计理念:**
当进场期第一天爆破指数仍然很高(>200)时,说明市场过热,给予负修正以降低质量评级;
当退场期第一天爆破指数已经为负值时,说明市场极度冷却,同样给予负修正警示风险。

### 技术改进

- 数据库表结构更新,支持保存爆破指数修正值
- 分析结果包含完整的修正值分解

---

## v2.0.0 (2025-10-16)

### 重大改进 🚀

#### 支持乱序和缺失日期录入
之前的版本严格依赖数据按日期顺序录入，现在完全支持：
- ✅ 任意顺序录入数据（可以先录10-15，再录10-11）
- ✅ 跳过某些日期后续补录
- ✅ 补录后重新分析得到正确结果

### 核心技术改进

#### 1. 数据库层 (database.py)
新增方法：
- `get_previous_day_data(coin, date)` - 查找真正的前一天数据
- `get_next_day_data(coin, date)` - 查找真正的后一天数据
- `find_crossing_node(coin, before_date, threshold, direction)` - 通用的跨越节点查找
- `delete_analysis_results(start_date, end_date)` - 删除旧分析结果
- `get_data_in_range(start_date, end_date)` - 获取日期范围数据

#### 2. 分析器层 (analyzer.py)
重构关键方法：
- `_detect_key_node()` - 使用 `get_previous_day_data()` 代替数组索引 `history[1]`
- `_find_reference_node()` - 使用 `find_crossing_node()` 查找参考节点
- 所有插值计算改用明确的日期查询而非数组遍历

#### 3. 新增工具 (mag_reanalyze.py)
全新的重新分析工具：
```bash
# 重新分析单个日期
python3 mag_reanalyze.py 2025-10-14

# 重新分析日期范围
python3 mag_reanalyze.py 2025-10-10 2025-10-15

# 重新分析指定币种
python3 mag_reanalyze.py 2025-10-10 2025-10-15 BTC ETH
```

### 问题修复

#### 修复前的问题
```python
# 旧版本的错误假设
history = db.get_coin_history(coin, limit=5)
today = history[0]       # ❌ 可能不是今天
yesterday = history[1]   # ❌ 可能不是昨天，可能是3天前！
```

**影响**：
- 如果日期乱序录入，会把错误的日期当作"昨天"
- 如果缺失日期，会跨越多天导致关键节点检测失败
- 插值计算使用不相邻的数据，误差可能达到85+点

#### 修复后的实现
```python
# 新版本使用日期查询
previous_data = db.get_previous_day_data(coin, current_date)  # ✅ 真正的前一天
```

**改进**：
- 无论数据如何录入，都能找到正确的前一天
- 即使缺失日期，也能准确计算
- 补录数据后重新分析即可更新结果

### 测试验证

#### 场景1: 乱序录入
```
录入顺序: 10-15 → 10-11 → 10-14
数据库按日期自动排序: 10-11, 10-14, 10-15
分析10-14时能正确找到10-11作为前一天 ✅
```

#### 场景2: 缺失日期
```
初始录入: 10-11, 10-14, 10-15 (缺少10-12, 10-13)
分析10-14: 使用10-11作为前一天 ✅
补录10-12后: 重新分析使用10-12作为前一天 ✅
```

#### 场景3: 跨越节点
```
10-10: 爆破250
10-11: (缺失)
10-12: 爆破190  ← 这里跌破200
10-13: (缺失)
10-14: 爆破180

能正确找到10-12作为跌破200的节点 ✅
```

### 破坏性变更

**无破坏性变更**，完全向后兼容。

旧版本录入的数据无需修改，新版本会自动正确处理。

### 升级建议

1. **如果你之前的数据是完整的、按顺序录入的**
   - 无需任何操作，系统继续正常工作

2. **如果你之前有乱序或缺失日期**
   - 运行一次重新分析即可：
   ```bash
   python3 mag_reanalyze.py 2025-01-01 2025-12-31
   ```

3. **如果你需要补录历史数据**
   - 直接导入，然后重新分析对应日期范围

### Git提交记录

```
6fd3e61 docs: 更新README说明v2.0新功能
c5a8f50 feat: 重构支持乱序和缺失日期录入
097a33f feat: Mag 现货提示系统 MVP 初始版本
```

---

## v1.0.0 (2025-10-15)

### 首次发布

#### 核心功能
- ✅ Notion数据抓取 (Firecrawl集成)
- ✅ 4种关键节点检测
- ✅ 插值法计算
- ✅ 对标链验证
- ✅ 质量判定（相变修正+美股修正）
- ✅ 分级建议（三类投资者）

#### 数据导入
- ✅ 手动录入
- ✅ CSV批量导入
- ✅ JSON批量导入
- ✅ 浮墨笔记HTML导入

#### 技术栈
- Python 3.9+
- SQLite
- BeautifulSoup4
- Rich CLI

#### 已知限制
- ⚠️ 必须按日期顺序录入
- ⚠️ 不支持日期缺失
- ⚠️ 不支持补录后重新分析

---

## 贡献者

- Flow - 系统设计与实现
- Claude Code - 开发辅助

## 许可证

MIT License
